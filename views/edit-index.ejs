<%- include('header', { pageName: '' }) %>

<h1 class="h2 mb-3">Select Page to Edit</h1>

<div class="row">
    <div class="col-md-8">
        <div class="mb-3">
            <p class="text-muted">Choose a page from the list below to edit, or search for a specific page.</p>
        </div>

        <!-- Search box -->
        <div class="form-group mb-4">
            <label for="pageSearch" class="form-label">Search Pages:</label>
            <input type="text" class="form-control" id="pageSearch" placeholder="Type to search for a page..." autocomplete="off">
        </div>

        <!-- Page list -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Available Pages (<span id="pageCount"><%= pages.length %></span>)</h5>
            </div>
            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                <div id="pageList">
                    <% if (pages.length === 0) { %>
                        <div class="text-center text-muted p-4">
                            <i class="fas fa-file-alt fa-3x mb-3"></i>
                            <p>No pages available.</p>
                            <a href="/create" class="btn" style="background-color: var(--btn-primary-bg); color: var(--btn-primary-text); border-color: var(--btn-primary-border);">Create Your First Page</a>
                        </div>
                    <% } else { %>
                        <div class="list-group list-group-flush">
                            <% pages.forEach(page => { %>
                                <a href="/edit/<%= encodeURIComponent(page) %>" class="list-group-item list-group-item-action page-item" data-page="<%= page.toLowerCase() %>">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-file-alt style="color: var(--text-primary);" me-2"></i>
                                            <span class="page-name"><%= page %></span>
                                        </div>
                                        <i class="fas fa-edit style="color: var(--text-secondary);""></i>
                                    </div>
                                </a>
                            <% }); %>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <a href="/" class="btn" style="background-color: var(--btn-secondary-bg); color: var(--btn-secondary-text); border-color: var(--btn-secondary-border);">
                <i class="fas fa-arrow-left"></i> Back to Home
            </a>
            <% if (currentUser && (currentUser.roles.includes('admin') || currentUser.roles.includes('editor') || currentUser.roles.includes('contributor'))) { %>
                <a href="/create" class="btn btn-success ms-2">
                    <i class="fas fa-plus"></i> Create New Page
                </a>
            <% } %>
        </div>
    </div>

    <!-- Sidebar with instructions -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle"></i> How to Edit
                </h6>
            </div>
            <div class="card-body">
                <ol class="small">
                    <li>Select a page from the list</li>
                    <li>Use the search box to quickly find pages</li>
                    <li>Click on any page to start editing</li>
                    <li>Save your changes when done</li>
                </ol>
                
                <hr>
                
                <h6>Quick Actions:</h6>
                <ul class="small text-muted">
                    <li>Click <i class="fas fa-edit"></i> to edit a page</li>
                    <li>Use search to filter the list</li>
                    <li>All changes are tracked with metadata</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('pageSearch');
    const pageItems = document.querySelectorAll('.page-item');
    const pageCount = document.getElementById('pageCount');
    
    // Search functionality
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        let visibleCount = 0;
        
        pageItems.forEach(item => {
            const pageName = item.getAttribute('data-page');
            if (pageName.includes(searchTerm)) {
                item.style.display = '';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        pageCount.textContent = visibleCount;
        
        // Show "no results" message if needed
        const noResults = document.getElementById('noResults');
        if (noResults) {
            noResults.remove();
        }
        
        if (visibleCount === 0 && searchTerm.length > 0) {
            const pageList = document.getElementById('pageList');
            const noResultsDiv = document.createElement('div');
            noResultsDiv.id = 'noResults';
            noResultsDiv.className = 'text-center text-muted p-4';
            noResultsDiv.innerHTML = `
                <i class="fas fa-search fa-2x mb-3"></i>
                <p>No pages found matching "<strong>${searchTerm}</strong>"</p>
                <button class="btn btn-link" onclick="document.getElementById('pageSearch').value=''; document.getElementById('pageSearch').dispatchEvent(new Event('input'));">Clear Search</button>
            `;
            pageList.appendChild(noResultsDiv);
        }
    });
    
    // Focus search on load
    searchInput.focus();
});
</script>

<!-- Page Link Autocomplete - Issue #90 -->
<script>
// Page autocomplete for edit index search
function initEditIndexAutocomplete() {
    if (typeof PageAutocomplete === 'undefined') {
        setTimeout(initEditIndexAutocomplete, 100);
        return;
    }

    const searchInput = document.getElementById('pageSearch');
    if (!searchInput) return;

    // Initialize page autocomplete
    const autocomplete = new PageAutocomplete({
        minChars: 2,
        maxSuggestions: 10,
        onSelect: function(suggestion) {
            // Navigate to edit the selected page
            window.location.href = `/edit/${encodeURIComponent(suggestion.name)}`;
        }
    });

    // Show autocomplete as user types (alongside existing filter)
    searchInput.addEventListener('input', function(e) {
        const query = searchInput.value.trim();

        if (query.length >= 2) {
            autocomplete.search(query, searchInput);
        } else {
            autocomplete.hideDropdown();
        }
    });

    // Handle keyboard navigation in autocomplete
    searchInput.addEventListener('keydown', function(e) {
        if (autocomplete.handleKeydown(e)) {
            // Autocomplete handled the key, prevent default
            e.preventDefault();
        }
    });

    // Hide autocomplete when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target !== searchInput) {
            autocomplete.hideDropdown();
        }
    });
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initEditIndexAutocomplete);
} else {
    initEditIndexAutocomplete();
}
</script>

<%- include('footer') %>
