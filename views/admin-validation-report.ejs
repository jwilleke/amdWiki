<%- include('header', { title: 'File Validation Report' }) %>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üìã File Validation Report</h1>
        <a href="/admin" class="btn" style="background-color: var(--btn-secondary-bg); color: var(--btn-secondary-text); border-color: var(--btn-secondary-border);">
          <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
      </div>
      
      <% if (dryRun) { %>
        <div class="alert alert-info">
          <strong>üîç Dry Run Mode:</strong> This report shows what <em>would</em> be fixed without making actual changes.
          <div class="mt-2">
            <a href="/admin/validate-files" class="btn btn-primary btn-sm">Run Real Validation</a>
          </div>
        </div>
      <% } else { %>
        <div class="alert alert-success">
          <strong>‚úÖ Live Mode:</strong> Files were actually validated and fixed where possible.
        </div>
      <% } %>
      
      <!-- Summary Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title style="color: var(--text-primary);""><%= report.totalFiles %></h5>
              <p class="card-text">Total Files</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title style="color: var(--text-success);""><%= report.validFiles %></h5>
              <p class="card-text">Valid Files</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title style="color: var(--text-warning);""><%= report.invalidFiles %></h5>
              <p class="card-text">Invalid Files</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title style="color: var(--text-info);""><%= report.fixedFiles %></h5>
              <p class="card-text">Fixed Files</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Validation Summary -->
      <div class="row">
        <div class="col-12">
          <div class="progress mb-3">
            <% 
              const validPercent = Math.round((report.validFiles / report.totalFiles) * 100);
              const validStyle = 'width: ' + validPercent + '%;';
            %>
            <div class="progress-bar bg-success" style="<%= validStyle %>">
              <%= validPercent %>% Valid
            </div>
            <% if (report.invalidFiles > 0) { %>
              <% 
                const invalidPercent = Math.round((report.invalidFiles / report.totalFiles) * 100);
                const invalidStyle = 'width: ' + invalidPercent + '%;';
              %>
              <div class="progress-bar bg-warning" style="<%= invalidStyle %>">
                <%= invalidPercent %>% Invalid
              </div>
            <% } %>
          </div>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <% if (report.invalidFiles > 0 && dryRun) { %>
        <div class="alert alert-warning">
          <strong>‚ö†Ô∏è Issues Found:</strong> <%= report.invalidFiles %> files need fixing.
          <div class="mt-2">
            <button id="fixAllBtn" class="btn btn-warning">
              üîß Fix All Issues
            </button>
            <small class="text-muted d-block mt-1">
              This will rename files to UUID format and add missing metadata.
            </small>
          </div>
        </div>
      <% } %>
      
      <!-- Detailed Results -->
      <div class="row mt-4">
        
        <!-- Errors Section -->
        <% if (report.errors.length > 0) { %>
          <div class="col-12 mb-4">
            <h3>‚ùå Validation Errors</h3>
            <div class="card">
              <div class="card-body">
                <ul class="list-group list-group-flush">
                  <% report.errors.forEach(error => { %>
                    <li class="list-group-item">
                      <code><%= error %></code>
                    </li>
                  <% }) %>
                </ul>
              </div>
            </div>
          </div>
        <% } %>
        
        <!-- Warnings Section -->
        <% if (report.warnings.length > 0) { %>
          <div class="col-12 mb-4">
            <h3>‚ö†Ô∏è Validation Warnings</h3>
            <div class="card">
              <div class="card-body">
                <ul class="list-group list-group-flush">
                  <% report.warnings.forEach(warning => { %>
                    <li class="list-group-item">
                      <code><%= warning %></code>
                    </li>
                  <% }) %>
                </ul>
              </div>
            </div>
          </div>
        <% } %>
        
        <!-- Fixes Section -->
        <% if (report.fixes.length > 0) { %>
          <div class="col-12 mb-4">
            <h3>üîß Suggested Fixes</h3>
            <div class="card">
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Original File</th>
                        <th>Suggested Filename</th>
                        <th>Missing Metadata</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% report.fixes.forEach(fix => { %>
                        <tr>
                          <td><code><%= fix.originalFile %></code></td>
                          <td>
                            <% if (fix.suggestedFilename && fix.suggestedFilename !== fix.originalFile) { %>
                              <code class="style="color: var(--text-success);""><%= fix.suggestedFilename %></code>
                            <% } else { %>
                              <span class="text-muted">No change</span>
                            <% } %>
                          </td>
                          <td>
                            <% const missingFields = [] %>
                            <% if (!fix.suggestedMetadata.uuid) missingFields.push('uuid') %>
                            <% if (!fix.suggestedMetadata.title) missingFields.push('title') %>
                            <% if (!fix.suggestedMetadata.slug) missingFields.push('slug') %>
                            <% if (!fix.suggestedMetadata['system-category']) missingFields.push('system-category') %>
                            <% if (!fix.suggestedMetadata['user-keywords']) missingFields.push('user-keywords') %>
                            <% if (!fix.suggestedMetadata.lastModified) missingFields.push('lastModified') %>
                            
                            <% if (missingFields.length > 0) { %>
                              <span class="badge" style="background-color: var(--badge-warning-bg); color: var(--badge-warning-text);"><%= missingFields.join(', ') %></span>
                            <% } else { %>
                              <span class="style="color: var(--text-success);"">All required fields present</span>
                            <% } %>
                          </td>
                        </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        <% } %>
        
      </div>
      
      <!-- Navigation -->
      <div class="row mt-4">
        <div class="col-12">
          <a href="/admin" class="btn" style="background-color: var(--btn-secondary-bg); color: var(--btn-secondary-text); border-color: var(--btn-secondary-border);">‚Üê Back to Admin Dashboard</a>
          <a href="/admin/validate-files?dryRun=true" class="btn btn-outline-primary">üîç Run Dry Run</a>
        </div>
      </div>
      
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const fixAllBtn = document.getElementById('fixAllBtn');
  if (fixAllBtn) {
    fixAllBtn.addEventListener('click', async function() {
      if (!confirm('Are you sure you want to fix all file naming and metadata issues? This will rename files and modify their content.')) {
        return;
      }
      
      fixAllBtn.disabled = true;
      fixAllBtn.innerHTML = 'üîÑ Fixing...';
      
      try {
        const response = await fetch('/admin/fix-files', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`‚úÖ Successfully fixed ${result.report.fixedFiles} files!`);
          window.location.reload();
        } else {
          alert(`‚ùå Error: ${result.error}`);
          fixAllBtn.disabled = false;
          fixAllBtn.innerHTML = 'üîß Fix All Issues';
        }
      } catch (error) {
        alert(`‚ùå Network error: ${error.message}`);
        fixAllBtn.disabled = false;
        fixAllBtn.innerHTML = 'üîß Fix All Issues';
      }
    });
  }
});
</script>

<%- include('footer') %>
