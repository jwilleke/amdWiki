<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Logs - amdWiki Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <style>
        .audit-table {
            font-size: 0.875rem;
        }
        .severity-low { color: #28a745; }
        .severity-medium { color: #ffc107; }
        .severity-high { color: #fd7e14; }
        .severity-critical { color: #dc3545; }
        .event-type-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .audit-filters {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        .stats-card {
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-2px);
        }
        .log-details {
            max-height: 400px;
            overflow-y: auto;
        }
        .export-options {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <%- include('../header') %>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1><i class="fas fa-shield-alt text-primary"></i> Audit Logs
                            <i class="fas fa-info-circle help-icon"
                               data-bs-toggle="popover"
                               data-bs-placement="right"
                               data-bs-html="true"
                               data-bs-content="<strong>Audit Trail System</strong><br>Monitor access control decisions, security events, and system activities.<br><br><em>Real-time monitoring of policy evaluations and access attempts.</em>"></i>
                        </h1>
                        <p class="text-muted mb-0">Comprehensive audit trail for access control and security monitoring</p>
                    </div>
                    <div>
                        <button type="button" class="btn btn-outline-primary" onclick="refreshAuditLogs()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="exportAuditLogs()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>

                <!-- Audit Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <h5 class="card-title text-primary"><%= auditStats.totalEvents %></h5>
                                <p class="card-text">Total Events
                                    <i class="fas fa-info-circle help-icon"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       title="Total number of audit events logged"></i>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <h5 class="card-title text-success"><%= auditStats.eventsByResult.allow || 0 %></h5>
                                <p class="card-text">Access Allowed
                                    <i class="fas fa-info-circle help-icon"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       title="Number of access requests that were allowed"></i>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <h5 class="card-title text-danger"><%= auditStats.eventsByResult.deny || 0 %></h5>
                                <p class="card-text">Access Denied
                                    <i class="fas fa-info-circle help-icon"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       title="Number of access requests that were denied"></i>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <h5 class="card-title text-warning"><%= auditStats.securityIncidents %></h5>
                                <p class="card-text">Security Incidents
                                    <i class="fas fa-info-circle help-icon"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       title="Number of high/critical severity security events"></i>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audit Filters -->
                <div class="audit-filters">
                    <h6><i class="fas fa-filter"></i> Search & Filter</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">User</label>
                            <input type="text" class="form-control" id="filterUser" placeholder="Username">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Event Type</label>
                            <select class="form-select" id="filterEventType">
                                <option value="">All Events</option>
                                <option value="access_decision">Access Decision</option>
                                <option value="authentication">Authentication</option>
                                <option value="security_event">Security Event</option>
                                <option value="policy_evaluation">Policy Evaluation</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Severity</label>
                            <select class="form-select" id="filterSeverity">
                                <option value="">All Severities</option>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Date Range</label>
                            <input type="date" class="form-control" id="filterStartDate">
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <label class="form-label">Resource/Action</label>
                            <input type="text" class="form-control" id="filterResource" placeholder="Resource or action">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary" onclick="applyFilters()">
                                    <i class="fas fa-search"></i> Apply Filters
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audit Log Table -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-list"></i> Audit Events</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="auditTable" class="table table-striped audit-table">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>User</th>
                                        <th>Event Type</th>
                                        <th>Resource</th>
                                        <th>Action</th>
                                        <th>Result</th>
                                        <th>Severity</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="auditTableBody">
                                    <% auditLogs.results.forEach(log => { %>
                                    <tr>
                                        <td><%= new Date(log.timestamp).toLocaleString() %></td>
                                        <td><%= log.user %></td>
                                        <td>
                                            <span class="badge bg-secondary event-type-badge">
                                                <%= log.eventType.replace('_', ' ') %>
                                            </span>
                                        </td>
                                        <td><%= log.resource || '-' %></td>
                                        <td><%= log.action || '-' %></td>
                                        <td>
                                            <% if (log.result === 'allow') { %>
                                                <span class="badge bg-success">Allow</span>
                                            <% } else if (log.result === 'deny') { %>
                                                <span class="badge bg-danger">Deny</span>
                                            <% } else if (log.result === 'error') { %>
                                                <span class="badge bg-warning">Error</span>
                                            <% } else { %>
                                                <span class="badge bg-secondary"><%= log.result %></span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <span class="severity-<%= log.severity %>">
                                                <i class="fas fa-circle"></i> <%= log.severity %>
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" data-log-id="<%= log.id %>" onclick="viewLogDetails(this.getAttribute('data-log-id'))">
                                                <i class="fas fa-eye"></i> Details
                                            </button>
                                        </td>
                                    </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <% if (auditLogs.total > auditLogs.limit) { %>
                        <nav aria-label="Audit log pagination" class="mt-3">
                            <ul class="pagination justify-content-center">
                                <% const totalPages = Math.ceil(auditLogs.total / auditLogs.limit);
                                   const currentPage = Math.floor(auditLogs.offset / auditLogs.limit) + 1;
                                   const startPage = Math.max(1, currentPage - 2);
                                   const endPage = Math.min(totalPages, currentPage + 2); %>

                                <% if (currentPage > 1) { %>
                                <li class="page-item">
                                    <a class="page-link" href="#" data-page="<%= currentPage - 1 %>" onclick="changePage(this.getAttribute('data-page'))">Previous</a>
                                </li>
                                <% } %>

                                <% for (let i = startPage; i <= endPage; i++) { %>
                                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                    <a class="page-link" href="#" data-page="<%= i %>" onclick="changePage(this.getAttribute('data-page'))"><%= i %></a>
                                </li>
                                <% } %>

                                <% if (currentPage < totalPages) { %>
                                <li class="page-item">
                                    <a class="page-link" href="#" data-page="<%= currentPage + 1 %>" onclick="changePage(this.getAttribute('data-page'))">Next</a>
                                </li>
                                <% } %>
                            </ul>
                        </nav>
                        <% } %>
                    </div>
                </div>

                <!-- Export Options -->
                <div class="export-options">
                    <h6><i class="fas fa-download"></i> Export Options</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Format</label>
                            <select class="form-select" id="exportFormat">
                                <option value="json">JSON</option>
                                <option value="csv">CSV</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Date Range</label>
                            <input type="date" class="form-control" id="exportStartDate">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-success" onclick="exportAuditLogs()">
                                <i class="fas fa-download"></i> Export Logs
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Details Modal -->
    <div class="modal fade" id="logDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Audit Event Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="logDetailsContent" class="log-details">
                        <!-- Log details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <script>
        let currentPage = 1;
        let currentFilters = {};

        $(document).ready(function() {
            // Initialize tooltips and popovers
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
            popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl);
            });

            // Initialize DataTable
            $('#auditTable').DataTable({
                "pageLength": 25,
                "order": [[ 0, "desc" ]],
                "columnDefs": [
                    { "orderable": false, "targets": 7 }
                ]
            });
        });

        function applyFilters() {
            currentFilters = {
                user: $('#filterUser').val(),
                eventType: $('#filterEventType').val(),
                severity: $('#filterSeverity').val(),
                startDate: $('#filterStartDate').val(),
                resource: $('#filterResource').val()
            };

            refreshAuditLogs();
        }

        function clearFilters() {
            $('#filterUser, #filterEventType, #filterSeverity, #filterStartDate, #filterResource').val('');
            currentFilters = {};
            refreshAuditLogs();
        }

        function refreshAuditLogs() {
            const params = new URLSearchParams({
                ...currentFilters,
                page: currentPage
            });

            window.location.href = `/admin/audit?${params.toString()}`;
        }

        function changePage(page) {
            currentPage = page;
            refreshAuditLogs();
        }

        function viewLogDetails(logId) {
            // Fetch log details via AJAX
            fetch(`/admin/audit/details/${logId}`)
                .then(response => response.json())
                .then(data => {
                    const detailsHtml = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Basic Information</h6>
                                <table class="table table-sm">
                                    <tr><td><strong>ID:</strong></td><td>${data.id}</td></tr>
                                    <tr><td><strong>Timestamp:</strong></td><td>${new Date(data.timestamp).toLocaleString()}</td></tr>
                                    <tr><td><strong>User:</strong></td><td>${data.user}</td></tr>
                                    <tr><td><strong>Event Type:</strong></td><td>${data.eventType}</td></tr>
                                    <tr><td><strong>Severity:</strong></td><td><span class="severity-${data.severity}"><i class="fas fa-circle"></i> ${data.severity}</span></td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6>Event Details</h6>
                                <table class="table table-sm">
                                    <tr><td><strong>Resource:</strong></td><td>${data.resource || '-'}</td></tr>
                                    <tr><td><strong>Action:</strong></td><td>${data.action || '-'}</td></tr>
                                    <tr><td><strong>Result:</strong></td><td>${data.result}</td></tr>
                                    <tr><td><strong>Reason:</strong></td><td>${data.reason}</td></tr>
                                    <tr><td><strong>Duration:</strong></td><td>${data.duration ? data.duration + 'ms' : '-'}</td></tr>
                                </table>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>Additional Context</h6>
                                <pre class="bg-light p-2 rounded"><code>${JSON.stringify(data.context || {}, null, 2)}</code></pre>
                            </div>
                        </div>
                        ${data.metadata ? `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>Metadata</h6>
                                <pre class="bg-light p-2 rounded"><code>${JSON.stringify(data.metadata, null, 2)}</code></pre>
                            </div>
                        </div>` : ''}
                    `;

                    $('#logDetailsContent').html(detailsHtml);
                    $('#logDetailsModal').modal('show');
                })
                .catch(error => {
                    console.error('Failed to load log details:', error);
                    alert('Failed to load log details. Please try again.');
                });
        }

        function exportAuditLogs() {
            const format = $('#exportFormat').val();
            const startDate = $('#exportStartDate').val();

            const params = new URLSearchParams({
                format: format,
                startDate: startDate || '',
                ...currentFilters
            });

            window.open(`/admin/audit/export?${params.toString()}`, '_blank');
        }
    </script>
</body>
</html>