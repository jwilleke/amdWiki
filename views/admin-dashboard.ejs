<%- include('header', { pageName: '' }) %>

<div class="container mt-4">
    <% if (typeof successMessage !== 'undefined' && successMessage) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> <%= successMessage %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle"></i> <%= errorMessage %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <div class="row">
        <div class="col-12">
            <h1><i class="fas fa-cogs"></i> Admin Dashboard</h1>
            <p class="lead">Welcome to the administration panel, <%= currentUser.displayName %>!</p>
        </div>
    </div>

    <div class="row mt-4">
        <!-- System Stats -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> System Statistics</h5>
                </div>
                <div class="card-body">
                    <p><strong>Total Pages:</strong> <%= pages.length %></p>
                    <p><strong>Total Users:</strong> <%= stats.totalUsers || 'N/A' %></p>
                    <p><strong>System Uptime:</strong> <%= stats.uptime || 'N/A' %></p>
                    <p><strong>Version:</strong> amdWiki 1.0.0</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <a href="/create" class="btn btn-primary btn-block mb-2">
                        <i class="fas fa-plus"></i> Create New Page
                    </a>
                    <a href="/admin/users" class="btn btn-info btn-block mb-2">
                        <i class="fas fa-users"></i> Manage Users
                    </a>
                    <a href="/admin/roles" class="btn btn-warning btn-block mb-2">
                        <i class="fas fa-shield-alt"></i> Manage Roles
                    </a>
                    <a href="/export" class="btn btn-success btn-block mb-2">
                        <i class="fas fa-download"></i> Export Data
                    </a>

                    <!-- Maintenance Mode Toggle -->
                    <div class="mt-3 pt-3 border-top">
                        <h6><i class="fas fa-wrench"></i> System Control</h6>
                        <form method="POST" action="/admin/maintenance/toggle" class="d-inline">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <% if (maintenanceMode) { %>
                                <button type="submit" class="btn btn-danger btn-sm btn-block" onclick="return confirm('Disable maintenance mode? Users will be able to access the system again.')">
                                    <i class="fas fa-play"></i> Disable Maintenance
                                </button>
                            <% } else { %>
                                <button type="submit" class="btn btn-warning btn-sm btn-block" onclick="return confirm('Enable maintenance mode? This will restrict access for regular users.')">
                                    <i class="fas fa-pause"></i> Enable Maintenance
                                </button>
                            <% } %>
                        </form>
                        <% if (maintenanceMode) { %>
                            <div class="mt-2">
                                <small class="text-danger">
                                    <i class="fas fa-exclamation-triangle"></i> Maintenance mode is currently <strong>ACTIVE</strong>
                                </small>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Required Pages Management -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-lock"></i> Required Pages (Admin Only)</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">These pages can only be edited by administrators:</p>
                    <% if (requiredPages && requiredPages.length > 0) { %>
                        <% requiredPages.forEach(pageName => { %>
                            <a href="/edit/<%= encodeURIComponent(pageName) %>" class="btn btn-outline-primary btn-block mb-2">
                                <i class="fas fa-edit"></i> Edit <%= pageName %>
                            </a>
                        <% }); %>
                    <% } else { %>
                        <p class="text-muted">No required pages found.</p>
                    <% } %>
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> All users can view these pages, but only admins can edit them.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Recent Activity -->
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-history"></i> Recent Activity</h5>
                </div>
                <div class="card-body">
                    <% if (recentActivity && recentActivity.length > 0) { %>
                        <% recentActivity.slice(0, 5).forEach(activity => { %>
                            <div class="mb-2">
                                <small class="text-muted"><%= activity.timestamp %></small><br>
                                <%= activity.description %>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <p class="text-muted">No recent activity to display.</p>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <!-- System Notifications -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-bell"></i> System Notifications</h5>
                    <span class="badge bg-primary"><%= notifications ? notifications.length : 0 %></span>
                </div>
                <div class="card-body">
                    <% if (notifications && notifications.length > 0) { %>
                        <% notifications.slice(0, 5).forEach(notification => { %>
                            <div class="alert alert-<%= notification.level === 'warning' ? 'warning' : notification.level === 'error' ? 'danger' : notification.level === 'success' ? 'success' : 'info' %> border-0 mb-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="alert-heading mb-1"><%= notification.title %></h6>
                                        <p class="mb-1"><%= notification.message %></p>
                                        <small class="text-muted">
                                            <i class="fas fa-clock"></i> <%= new Date(notification.createdAt).toLocaleString() %>
                                            <% if (notification.type) { %>
                                                <span class="badge bg-secondary ms-2"><%= notification.type %></span>
                                            <% } %>
                                        </small>
                                    </div>
                                    <div class="ms-3">
                                        <form method="POST" action="/admin/notifications/<%= notification.id %>/dismiss" class="d-inline">
                                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                            <button type="submit" class="btn btn-sm btn-outline-secondary" title="Dismiss notification">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                        
                        <% if (notifications.length > 5) { %>
                            <div class="text-center">
                                <a href="/admin/notifications" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-list"></i> View All Notifications (<%= notifications.length %>)
                                </a>
                            </div>
                        <% } %>
                    <% } else { %>
                        <div class="text-center py-4">
                            <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No system notifications at this time.</p>
                            <small class="text-muted">Notifications will appear here when system events occur.</small>
                        </div>
                    <% } %>
                </div>
                <div class="card-footer">
                    <div class="row">
                        <div class="col-md-6">
                            <form method="POST" action="/admin/notifications/clear-all" class="d-inline">
                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Clear all notifications? This action cannot be undone.')">
                                    <i class="fas fa-trash"></i> Clear All
                                </button>
                            </form>
                        </div>
                        <div class="col-md-6 text-end">
                            <a href="/admin/notifications" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-cog"></i> Manage Notifications
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <!-- User Management -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-users-cog"></i> User Management</h5>
                </div>
                <div class="card-body">
                    <p>Manage user accounts, roles, and permissions.</p>
                    <a href="/admin/users" class="btn" style="background-color: var(--btn-primary-bg); color: var(--btn-primary-text); border-color: var(--btn-primary-border);">
                        <i class="fas fa-users"></i> Go to User Management
                    </a>
                </div>
            </div>
        </div>

        <!-- System Settings -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-cog"></i> System Settings</h5>
                </div>
                <div class="card-body">
                    <p>Configure wiki settings and system preferences.</p>
                    <div class="btn-group">
                        <a href="/admin/roles" class="btn" style="background-color: var(--btn-secondary-bg); color: var(--btn-secondary-text); border-color: var(--btn-secondary-border);">
                            <i class="fas fa-shield-alt"></i> Roles
                        </a>
                        <a href="/admin/configuration" class="btn" style="background-color: var(--btn-secondary-bg); color: var(--btn-secondary-text); border-color: var(--btn-secondary-border);">
                            <i class="fas fa-sliders-h"></i> Configuration
                        </a>
                        <a href="/admin/variables" class="btn" style="background-color: var(--btn-secondary-bg); color: var(--btn-secondary-text); border-color: var(--btn-secondary-border);">
                            <i class="fas fa-code"></i> Variables
                        </a>
                        <a href="/admin/settings" class="btn" style="background-color: var(--btn-secondary-bg); color: var(--btn-secondary-text); border-color: var(--btn-secondary-border);">
                            <i class="fas fa-cogs"></i> Settings
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <% if (currentUser.roles.includes('admin')) { %>
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning">
                    <h5><i class="fas fa-exclamation-triangle"></i> Administrator Tools</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <h6>System Maintenance</h6>
                            <button class="btn btn-sm" style="background-color: var(--btn-outline-danger-bg); color: var(--btn-outline-danger-text); border-color: var(--btn-outline-danger-border);" onclick="confirmRestart()">
                                <i class="fas fa-sync-alt"></i> Restart System
                            </button>
                        </div>
                        <div class="col-md-3">
                            <h6>Data Management</h6>
                            <a href="/admin/backup" class="btn btn-sm" style="background-color: var(--btn-outline-info-bg); color: var(--btn-outline-info-text); border-color: var(--btn-outline-info-border);">
                                <i class="fas fa-database"></i> Backup Data
                            </a>
                        </div>
                        <div class="col-md-3">
                            <h6>Logs</h6>
                            <a href="/admin/logs" class="btn btn-sm" style="background-color: var(--btn-outline-secondary-bg); color: var(--btn-outline-secondary-text); border-color: var(--btn-outline-secondary-border);">
                                <i class="fas fa-file-alt"></i> View Logs
                            </a>
                        </div>
                        <div class="col-md-3">
                            <h6>Performance</h6>
                            <button class="btn btn-outline-success btn-sm" onclick="clearCache()">
                                <i class="fas fa-broom"></i> Clear Cache
                            </button>
                            <button class="btn btn-outline-primary btn-sm mt-2" onclick="reindexPages()">
                                <i class="fas fa-sync"></i> Reindex Pages
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <% } %>
</div>

<script>
async function confirmRestart() {
    if (!confirm('Are you sure you want to restart the system? This will temporarily interrupt service.')) {
        return;
    }

    try {
        const response = await fetch('/admin/restart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();

        if (result.success) {
            alert('System is restarting. The page will reload in a few seconds...');
            // Wait for restart and reload
            setTimeout(() => {
                window.location.reload();
            }, 5000);
        } else {
            alert('Error restarting system: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Restart error:', error);
        alert('Error restarting system: ' + error.message);
    }
}

async function clearCache() {
    if (!confirm('Are you sure you want to clear all cache data? This action cannot be undone.')) {
        return;
    }

    const button = document.querySelector('button[onclick="clearCache()"]');
    const originalText = button.textContent;
    
    try {
        button.disabled = true;
        button.textContent = 'Clearing...';
        
        const response = await fetch('/api/admin/cache/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            button.classList.remove('btn-outline-success');
            button.classList.add('btn-success');
            button.textContent = 'âœ“ Cache Cleared';
            
            // Show success message
            showMessage('All caches cleared successfully', 'success');
            
            // Reset button after 3 seconds
            setTimeout(() => {
                button.disabled = false;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-success');
                button.textContent = originalText;
            }, 3000);
        } else {
            throw new Error(result.error || 'Failed to clear cache');
        }
    } catch (error) {
        console.error('Cache clear error:', error);
        button.disabled = false;
        button.textContent = originalText;
        showMessage('Failed to clear cache: ' + error.message, 'error');
    }
}

async function reindexPages() {
    if (!confirm('Are you sure you want to reindex all pages? This will refresh the page cache and rebuild the search index.')) {
        return;
    }

    const button = document.querySelector('button[onclick="reindexPages()"]');
    const originalText = button.innerHTML;

    try {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reindexing...';

        const response = await fetch('/admin/reindex', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const result = await response.json();

        if (response.ok && result.success) {
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-primary');
            button.innerHTML = '<i class="fas fa-check"></i> Reindexed';

            // Show success message with stats
            const stats = result.stats || {};
            const message = `Reindexing complete! Pages: ${stats.pageCount || 0}, Search docs: ${stats.searchDocuments || 0}`;
            showMessage(message, 'success');

            // Reset button after 3 seconds
            setTimeout(() => {
                button.disabled = false;
                button.classList.remove('btn-primary');
                button.classList.add('btn-outline-primary');
                button.innerHTML = originalText;
            }, 3000);
        } else {
            throw new Error(result.error || 'Failed to reindex pages');
        }
    } catch (error) {
        console.error('Reindex error:', error);
        button.disabled = false;
        button.innerHTML = originalText;
        showMessage('Failed to reindex: ' + error.message, 'error');
    }
}

function showMessage(message, type) {
    // Create or update message element
    let messageEl = document.querySelector('#cache-message');
    if (!messageEl) {
        messageEl = document.createElement('div');
        messageEl.id = 'cache-message';
        messageEl.style.position = 'fixed';
        messageEl.style.top = '20px';
        messageEl.style.right = '20px';
        messageEl.style.zIndex = '9999';
        messageEl.style.padding = '10px 15px';
        messageEl.style.borderRadius = '4px';
        messageEl.style.minWidth = '300px';
        document.body.appendChild(messageEl);
    }
    
    messageEl.textContent = message;
    messageEl.className = type === 'success' ? 'alert alert-success' : 'alert alert-danger';
    messageEl.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        messageEl.style.display = 'none';
    }, 5000);
}
</script>

<%- include('footer') %>
