<%- include('header', { pageName: '' }) %>

<div class="container mt-4">
    <% if (typeof successMessage !== 'undefined' && successMessage) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> <%= successMessage %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle"></i> <%= errorMessage %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <div class="row">
        <div class="col-12">
            <h1><i class="fas fa-cogs"></i> Admin Dashboard</h1>
            <p class="lead">Welcome to the administration panel, <%= currentUser.displayName %>!</p>
        </div>
    </div>

    <!-- User Management -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-users-cog"></i> User Management</h5>
                </div>
                <div class="card-body">
                    <a href="/admin/users" class="btn btn-info btn-sm">
                        <i class="fas fa-users"></i> Manage Users
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- System Settings -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-cog"></i> System Settings</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        <a href="/admin/roles" class="btn btn-sm" style="background-color: var(--btn-secondary-bg); color: var(--btn-secondary-text); border-color: var(--btn-secondary-border);">
                            <i class="fas fa-shield-alt"></i> Roles
                        </a>
                        <a href="/admin/configuration" class="btn btn-sm" style="background-color: var(--btn-secondary-bg); color: var(--btn-secondary-text); border-color: var(--btn-secondary-border);">
                            <i class="fas fa-sliders-h"></i> Configuration
                        </a>
                        <a href="/admin/variables" class="btn btn-sm" style="background-color: var(--btn-secondary-bg); color: var(--btn-secondary-text); border-color: var(--btn-secondary-border);">
                            <i class="fas fa-code"></i> Variables
                        </a>
                        <a href="/admin/settings" class="btn btn-sm" style="background-color: var(--btn-secondary-bg); color: var(--btn-secondary-text); border-color: var(--btn-secondary-border);">
                            <i class="fas fa-cogs"></i> Settings
                        </a>
                        <a href="/create" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus"></i> Create New Page
                        </a>
                        <a href="/export" class="btn btn-success btn-sm">
                            <i class="fas fa-download"></i> Export Data
                        </a>
                        <a href="/admin/import" class="btn btn-info btn-sm">
                            <i class="fas fa-file-import"></i> Import Pages
                        </a>
                        <a href="/admin/attachments" class="btn btn-sm" style="background-color: var(--btn-secondary-bg); color: var(--btn-secondary-text); border-color: var(--btn-secondary-border);">
                            <i class="fas fa-paperclip"></i> Attachments
                        </a>
                        <a href="/admin/keywords" class="btn btn-sm" style="background-color: var(--btn-secondary-bg); color: var(--btn-secondary-text); border-color: var(--btn-secondary-border);">
                            <i class="fas fa-tags"></i> Keywords
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Administrator Tools -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-tools"></i> Administrator Tools</h5>
                </div>
                <div class="card-body">
                    <% if (currentUser.roles.includes('admin')) { %>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-sm" style="background-color: var(--btn-outline-danger-bg); color: var(--btn-outline-danger-text); border-color: var(--btn-outline-danger-border);" onclick="confirmRestart()">
                            <i class="fas fa-sync-alt"></i> Restart
                        </button>
                        <a href="/admin/backup" class="btn btn-sm" style="background-color: var(--btn-outline-info-bg); color: var(--btn-outline-info-text); border-color: var(--btn-outline-info-border);">
                            <i class="fas fa-database"></i> Backup
                        </a>
                        <a href="/admin/import" class="btn btn-sm" style="background-color: var(--btn-outline-info-bg); color: var(--btn-outline-info-text); border-color: var(--btn-outline-info-border);">
                            <i class="fas fa-file-import"></i> Import
                        </a>
                        <a href="/admin/logs" class="btn btn-sm" style="background-color: var(--btn-outline-secondary-bg); color: var(--btn-outline-secondary-text); border-color: var(--btn-outline-secondary-border);">
                            <i class="fas fa-file-alt"></i> Logs
                        </a>
                        <button class="btn btn-outline-success btn-sm" onclick="clearCache()">
                            <i class="fas fa-broom"></i> Clear Cache
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="reindexPages()">
                            <i class="fas fa-sync"></i> Reindex
                        </button>
                        <form method="POST" action="/admin/maintenance/toggle" class="d-inline">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <% if (maintenanceMode) { %>
                                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Disable maintenance mode? Users will be able to access the system again.')">
                                    <i class="fas fa-play"></i> Disable Maintenance
                                </button>
                            <% } else { %>
                                <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('Enable maintenance mode? This will restrict access for regular users.')">
                                    <i class="fas fa-pause"></i> Enable Maintenance
                                </button>
                            <% } %>
                        </form>
                    </div>
                    <% if (maintenanceMode) { %>
                        <div class="mt-2">
                            <small class="text-danger">
                                <i class="fas fa-exclamation-triangle"></i> Maintenance mode is currently <strong>ACTIVE</strong>
                            </small>
                        </div>
                    <% } %>
                    <% } else { %>
                        <p class="text-muted">Admin role required for these tools.</p>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2: Recent Activity & System Notifications -->
    <div class="row">
        <!-- Recent Activity -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-history"></i> Recent Activity</h5>
                </div>
                <div class="card-body">
                    <% if (recentActivity && recentActivity.length > 0) { %>
                        <% recentActivity.slice(0, 5).forEach(activity => { %>
                            <div class="mb-2">
                                <small class="text-muted"><%= activity.timestamp %></small><br>
                                <%= activity.description %>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <p class="text-muted">No recent activity to display.</p>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- System Notifications -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-bell"></i> System Notifications</h5>
                    <span class="badge bg-primary"><%= notifications ? notifications.length : 0 %></span>
                </div>
                <div class="card-body">
                    <% if (notifications && notifications.length > 0) { %>
                        <% notifications.slice(0, 5).forEach(notification => { %>
                            <div class="alert alert-<%= notification.level === 'warning' ? 'warning' : notification.level === 'error' ? 'danger' : notification.level === 'success' ? 'success' : 'info' %> border-0 mb-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="alert-heading mb-1"><%= notification.title %></h6>
                                        <p class="mb-1"><%= notification.message %></p>
                                        <small class="text-muted">
                                            <i class="fas fa-clock"></i> <%= new Date(notification.createdAt).toLocaleString() %>
                                            <% if (notification.type) { %>
                                                <span class="badge bg-secondary ms-2"><%= notification.type %></span>
                                            <% } %>
                                        </small>
                                    </div>
                                    <div class="ms-3">
                                        <form method="POST" action="/admin/notifications/<%= notification.id %>/dismiss" class="d-inline">
                                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                            <button type="submit" class="btn btn-sm btn-outline-secondary" title="Dismiss notification">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        <% }); %>

                        <% if (notifications.length > 5) { %>
                            <div class="text-center">
                                <a href="/admin/notifications" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-list"></i> View All Notifications (<%= notifications.length %>)
                                </a>
                            </div>
                        <% } %>
                    <% } else { %>
                        <div class="text-center py-4">
                            <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No system notifications at this time.</p>
                            <small class="text-muted">Notifications will appear here when system events occur.</small>
                        </div>
                    <% } %>
                </div>
                <div class="card-footer">
                    <div class="row">
                        <div class="col-md-6">
                            <form method="POST" action="/admin/notifications/clear-all" class="d-inline">
                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Clear all notifications? This action cannot be undone.')">
                                    <i class="fas fa-trash"></i> Clear All
                                </button>
                            </form>
                        </div>
                        <div class="col-md-6 text-end">
                            <a href="/admin/notifications" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-cog"></i> Manage Notifications
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 3: Required Pages (full width) -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-lock"></i> Required Pages (Admin Only)</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">These pages can only be edited by administrators:</p>
                    <% if (requiredPages && requiredPages.length > 0) { %>
                        <div class="d-flex flex-wrap gap-2">
                        <% requiredPages.forEach(pageName => { %>
                            <a href="/edit/<%= encodeURIComponent(pageName) %>" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-edit"></i> Edit <%= pageName %>
                            </a>
                        <% }); %>
                        </div>
                    <% } else { %>
                        <p class="text-muted">No required pages found.</p>
                    <% } %>
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> All users can view these pages, but only admins can edit them.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function confirmRestart() {
    if (!confirm('Are you sure you want to restart the system? This will temporarily interrupt service.')) {
        return;
    }

    try {
        const response = await fetch('/admin/restart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();

        if (result.success) {
            alert('System is restarting. The page will reload in a few seconds...');
            // Wait for restart and reload
            setTimeout(() => {
                window.location.reload();
            }, 5000);
        } else {
            alert('Error restarting system: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Restart error:', error);
        alert('Error restarting system: ' + error.message);
    }
}

async function clearCache() {
    if (!confirm('Are you sure you want to clear all cache data? This action cannot be undone.')) {
        return;
    }

    const button = document.querySelector('button[onclick="clearCache()"]');
    const originalText = button.textContent;
    
    try {
        button.disabled = true;
        button.textContent = 'Clearing...';
        
        const response = await fetch('/api/admin/cache/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            button.classList.remove('btn-outline-success');
            button.classList.add('btn-success');
            button.textContent = 'âœ“ Cache Cleared';
            
            // Show success message
            showMessage('All caches cleared successfully', 'success');
            
            // Reset button after 3 seconds
            setTimeout(() => {
                button.disabled = false;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-success');
                button.textContent = originalText;
            }, 3000);
        } else {
            throw new Error(result.error || 'Failed to clear cache');
        }
    } catch (error) {
        console.error('Cache clear error:', error);
        button.disabled = false;
        button.textContent = originalText;
        showMessage('Failed to clear cache: ' + error.message, 'error');
    }
}

async function reindexPages() {
    if (!confirm('Are you sure you want to reindex all pages? This will refresh the page cache and rebuild the search index.')) {
        return;
    }

    const button = document.querySelector('button[onclick="reindexPages()"]');
    const originalText = button.innerHTML;

    try {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reindexing...';

        // Get CSRF token from the page
        const csrfToken = document.querySelector('input[name="_csrf"]')?.value || '<%= csrfToken %>';

        const response = await fetch('/admin/reindex', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'CSRF-Token': csrfToken
            },
            body: JSON.stringify({ _csrf: csrfToken })
        });

        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Non-JSON response:', text);
            throw new Error('Server returned non-JSON response. Check console for details.');
        }

        const result = await response.json();

        if (response.ok && result.success) {
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-primary');
            button.innerHTML = '<i class="fas fa-check"></i> Reindexed';

            // Show success message with stats
            const stats = result.stats || {};
            const message = `Reindexing complete! Pages: ${stats.pageCount || 0}, Search docs: ${stats.searchDocuments || 0}`;
            showMessage(message, 'success');

            // Reset button after 3 seconds
            setTimeout(() => {
                button.disabled = false;
                button.classList.remove('btn-primary');
                button.classList.add('btn-outline-primary');
                button.innerHTML = originalText;
            }, 3000);
        } else {
            throw new Error(result.error || 'Failed to reindex pages');
        }
    } catch (error) {
        console.error('Reindex error:', error);
        button.disabled = false;
        button.innerHTML = originalText;
        showMessage('Failed to reindex: ' + error.message, 'error');
    }
}

function showMessage(message, type) {
    // Create or update message element
    let messageEl = document.querySelector('#admin-message');
    if (!messageEl) {
        messageEl = document.createElement('div');
        messageEl.id = 'admin-message';
        messageEl.style.position = 'fixed';
        messageEl.style.top = '80px';
        messageEl.style.right = '20px';
        messageEl.style.zIndex = '9999';
        messageEl.style.minWidth = '350px';
        messageEl.style.maxWidth = '500px';
        messageEl.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
        document.body.appendChild(messageEl);
    }

    // Create card structure
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';

    messageEl.innerHTML = `
        <div class="card">
            <div class="card-header ${bgClass} text-white">
                <h6 class="mb-0"><i class="fas ${icon}"></i> ${type === 'success' ? 'Success' : 'Error'}</h6>
            </div>
            <div class="card-body">
                ${message}
            </div>
        </div>
    `;
    messageEl.style.display = 'block';

    // Fade in
    messageEl.style.opacity = '0';
    messageEl.style.transition = 'opacity 0.3s ease-in-out';
    setTimeout(() => messageEl.style.opacity = '1', 10);

    // Auto-hide after 5 seconds with fade out
    setTimeout(() => {
        messageEl.style.opacity = '0';
        setTimeout(() => messageEl.style.display = 'none', 300);
    }, 5000);
}
</script>

<%- include('footer') %>
