<%- include('header', { pageName: pageName || '' }) %>

<h1 class="h2 mb-3">Create New Page</h1>

<form action="/create" method="POST">
    <div class="row">
        <div class="col-md-8">
            <!-- Page Name -->
            <div class="form-group mb-3">
                <label for="pageName" style="font-weight:bold;">Page Name *</label>
                <input type="text" class="form-control" id="pageName" name="pageName" value="<%= pageName %>" required placeholder="Enter page name">
            </div>

            <!-- Template Selection -->
            <div class="form-group mb-3">
                <label style="font-weight:bold;">Choose Template *</label>
                <div class="template-selector">
                    <% templates.forEach((template, index) => { %>
                        <div class="template-option">
                            <input type="radio" id="template-<%= template.name %>" name="templateName" value="<%= template.name %>" <%= index === 0 ? 'checked' : '' %> required>
                            <label for="template-<%= template.name %>">
                                <strong><%= template.name.charAt(0).toUpperCase() + template.name.slice(1) %></strong>
                                <% if (template.name === 'default') { %>
                                    - Basic page template with overview and content sections
                                <% } else if (template.name === 'documentation') { %>
                                    - Documentation template with instructions and examples
                                <% } else if (template.name === 'category') { %>
                                    - Category page template for organizing related pages
                                <% } else if (template.name === 'meeting-notes') { %>
                                    - Meeting notes template with agenda and action items
                                <% } %>
                            </label>
                        </div>
                    <% }); %>
                </div>
            </div>

            <!-- Category Selection -->
            <div class="form-group mb-3">
                <label for="category-select" style="font-weight:bold;">Category *</label>
                <select class="form-control" id="category-select" name="category" required>
                    <option value="" disabled selected>-- Select Category --</option>
                    <% categories.forEach(category => { %>
                        <option value="<%= category %>"><%= category %></option>
                    <% }); %>
                </select>
            </div>

            <!-- User Keywords -->
            <div class="form-group mb-3">
                <label style="font-weight:bold;">User-Keywords (optional, max 3):</label>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" id="keywordsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <span id="selectedKeywordsText">Select keywords...</span>
                    </button>
                    <ul class="dropdown-menu w-100" aria-labelledby="keywordsDropdown" style="max-height: 300px; overflow-y: auto;">
                        <% userKeywords.forEach(keyword => { %>
                            <li>
                                <div class="dropdown-item-checkbox px-3 py-2">
                                    <div class="form-check">
                                        <input class="form-check-input user-keyword-checkbox" type="checkbox" name="userKeywords[]" value="<%= keyword %>" id="dropdown-keyword-<%= keyword %>">
                                        <label class="form-check-label ms-2" for="dropdown-keyword-<%= keyword %>"><%= keyword %></label>
                                    </div>
                                </div>
                            </li>
                        <% }); %>
                    </ul>
                </div>
            </div>

            <!-- Buttons -->
            <div class="form-group">
                <button type="submit" class="btn btn-primary">Create Page</button>
                <a href="/" class="btn btn-secondary ml-2">Cancel</a>
            </div>
        </div>
        
        <!-- Template Preview -->
        <div class="col-md-4">
            <div class="template-preview-container">
                <label style="font-weight:bold;">Template Preview:</label>
                <div id="template-preview" class="template-preview">
                    <em>Select a template to see preview</em>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
// Dropdown and keyword selection functionality
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.user-keyword-checkbox');
    const maxKeywords = 3;
    const selectedKeywordsText = document.getElementById('selectedKeywordsText');
    const dropdown = document.getElementById('keywordsDropdown');
    
    // Update the dropdown button text and disable/enable checkboxes
    function updateKeywordDisplay() {
        const checkedBoxes = document.querySelectorAll('.user-keyword-checkbox:checked');
        const selectedKeywords = Array.from(checkedBoxes).map(cb => cb.value);
        
        // Update button text
        if (selectedKeywords.length === 0) {
            selectedKeywordsText.textContent = 'Select keywords...';
            dropdown.classList.remove('btn-primary');
            dropdown.classList.add('btn-outline-secondary');
        } else {
            selectedKeywordsText.textContent = selectedKeywords.join(', ');
            dropdown.classList.remove('btn-outline-secondary');
            dropdown.classList.add('btn-primary');
        }
        
        // Disable unchecked boxes if we've reached the limit
        checkboxes.forEach(checkbox => {
            if (!checkbox.checked && checkedBoxes.length >= maxKeywords) {
                checkbox.disabled = true;
                checkbox.parentElement.parentElement.classList.add('text-muted');
            } else {
                checkbox.disabled = false;
                checkbox.parentElement.parentElement.classList.remove('text-muted');
            }
        });
    }
    
    // Add event listeners to checkboxes
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const checkedBoxes = document.querySelectorAll('.user-keyword-checkbox:checked');
            
            if (checkedBoxes.length > maxKeywords) {
                this.checked = false;
                alert(`You can select a maximum of ${maxKeywords} keywords.`);
            }
            
            updateKeywordDisplay();
        });
    });
    
    // Prevent dropdown from closing when clicking on checkboxes
    document.querySelectorAll('.dropdown-item-checkbox').forEach(item => {
        item.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });
    
    // Initialize display
    updateKeywordDisplay();
    
    // Template preview functionality
    const templateRadios = document.querySelectorAll('input[name="templateName"]');
    const preview = document.getElementById('template-preview');
    
    // Template descriptions for preview
    const templatePreviews = {
        'default': `<h1>Page Name</h1>
<h2>Overview</h2>
<p>Page Name is...</p>
<h2>Content</h2>
<p>Add your content here.</p>
<h2>More Information</h2>
<p>Referring pages will be listed here.</p>`,
        
        'documentation': `<h1>Page Name</h1>
<h2>Purpose</h2>
<p>This document describes...</p>
<h2>Instructions</h2>
<ol><li>Step one</li><li>Step two</li></ol>
<h2>Examples</h2>
<p>Code examples here...</p>`,
        
        'category': `<h1>Page Name</h1>
<h2>Overview</h2>
<p>Page Name contains pages related to...</p>
<h2>Subcategories</h2>
<ul><li>Subcategory 1</li><li>Subcategory 2</li></ul>`,
        
        'meeting-notes': `<h1>Page Name</h1>
<p><strong>Date:</strong> Current Date</p>
<p><strong>Attendees:</strong></p>
<h2>Agenda</h2>
<ol><li>Item 1</li><li>Item 2</li></ol>
<h2>Action Items</h2>
<ul><li>‚òê Action item 1</li></ul>`
    };
    
    function updatePreview() {
        const selectedTemplate = document.querySelector('input[name="templateName"]:checked');
        if (selectedTemplate && templatePreviews[selectedTemplate.value]) {
            preview.innerHTML = templatePreviews[selectedTemplate.value];
        }
    }
    
    templateRadios.forEach(radio => {
        radio.addEventListener('change', updatePreview);
    });
    
    // Initial preview
    updatePreview();
});
</script>

<%- include('footer') %>
