version: '3.8'

services:
  amdwiki:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: amdwiki
    restart: unless-stopped

    # User configuration
    user: "${UID:-1000}:${GID:-1000}"

    # Environment variables
    # INSTANCE_DATA_FOLDER: Base path for all instance data (pages, users, logs, etc.)
    # INSTANCE_CONFIG_FILE: Config filename to load from INSTANCE_DATA_FOLDER/config/
    # EXTERNAL_PORT: Not used with Traefik (accessed via domain, set to 443 for HTTPS)
    # AMDWIKI_DOMAIN: Automatically set baseURL and hostname from .env
    #
    # Configuration merge order:
    #   1. config/app-default-config.json (read-only, in image)
    #   2. INSTANCE_DATA_FOLDER/config/{INSTANCE_CONFIG_FILE} (instance overrides)
    environment:
      - NODE_ENV=production
      - INSTANCE_DATA_FOLDER=${INSTANCE_DATA_FOLDER:-./data}
      - INSTANCE_CONFIG_FILE=${INSTANCE_CONFIG_FILE:-app-custom-config.json}
      - EXTERNAL_PORT=443
      - AMDWIKI_BASE_URL=https://${AMDWIKI_DOMAIN}
      - AMDWIKI_HOSTNAME=${AMDWIKI_DOMAIN}

    # Volume mounts for persistent data
    # All instance data is consolidated under /app/data (single volume)
    # Config properties reference subdirectories within data/:
    # - amdwiki.page.provider.filesystem.storagedir: ./data/pages
    # - amdwiki.user.provider.storagedir: ./data/users
    # - amdwiki.attachment.provider.basic.storagedir: ./data/attachments
    # - amdwiki.logging.dir: ./data/logs
    # - amdwiki.search.provider.lunr.indexdir: ./data/search-index
    # - amdwiki.backup.directory: ./data/backups
    volumes:
      # All instance data (pages, users, attachments, logs, search-index, backups, sessions)
      - ../data:/app/data

      # Required pages (system templates - read-only, copied to data/pages on install)
      - ../required-pages:/app/required-pages

      # Optional: Mount custom configuration
      # - ../config/app-custom-config.json:/app/config/app-custom-config.json

    # Health check
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/', (r) => process.exit((r.statusCode === 200 || r.statusCode === 302) ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

    # Resource limits (optional)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

    # Traefik labels
    labels:
      # Enable Traefik for this container
      - "traefik.enable=true"

      # HTTP Router - Redirect to HTTPS
      - "traefik.http.routers.amdwiki-http.rule=Host(`${AMDWIKI_DOMAIN}`)"
      - "traefik.http.routers.amdwiki-http.entrypoints=web"
      - "traefik.http.routers.amdwiki-http.middlewares=amdwiki-redirect-https"

      # HTTPS Router with Authelia
      - "traefik.http.routers.amdwiki.rule=Host(`${AMDWIKI_DOMAIN}`)"
      - "traefik.http.routers.amdwiki.entrypoints=websecure"
      - "traefik.http.routers.amdwiki.tls=true"
      - "traefik.http.routers.amdwiki.tls.certresolver=letsencrypt"
      - "traefik.http.routers.amdwiki.middlewares=authelia@docker"

      # Service definition
      - "traefik.http.services.amdwiki.loadbalancer.server.port=3000"

      # Middleware: Redirect HTTP to HTTPS
      - "traefik.http.middlewares.amdwiki-redirect-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.amdwiki-redirect-https.redirectscheme.permanent=true"

    # Connect to Traefik network
    networks:
      - traefik_net

networks:
  traefik_net:
    external: true
