version: '3.8'

services:
  amdwiki:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: amdwiki
    restart: unless-stopped

    # User configuration
    # Run container as specific UID:GID to match host user and avoid permission issues
    # Default: 1000:1000 (standard 'node' user in the container)
    # Set in .env file or override at runtime: UID=1001 GID=1001 docker-compose up
    # To use current user: export UID=$(id -u) GID=$(id -g) && docker-compose up
    user: "${UID:-1000}:${GID:-1000}"

    # Port mapping
    # Maps container port to host port
    # ConfigurationManager uses amdwiki.server.port (default: 3000)
    #
    # The host port can be customized via HOST_PORT environment variable:
    # - Set in .env file: HOST_PORT=8080
    # - Or command line: HOST_PORT=8080 docker-compose up
    # - Or use "3000" to let Docker auto-assign a random port
    ports:
      - "${HOST_PORT:-3000}:3000"

    # Environment variables
    # NODE_ENV determines which config file is loaded by ConfigurationManager:
    # - production: config/app-production-config.json
    # - development: config/app-development-config.json
    # - test: config/app-test-config.json
    # INSTANCE_DATA_FOLDER: Base path for all instance data (pages, users, logs, etc.)
    # EXTERNAL_PORT: The host port for user-facing URLs (for logging)
    environment:
      - NODE_ENV=production
      - INSTANCE_DATA_FOLDER=${INSTANCE_DATA_FOLDER:-./data}
      - EXTERNAL_PORT=${HOST_PORT:-3000}

    # Volume mounts for persistent data
    # All instance data is consolidated under /app/data (single volume)
    # Config properties reference subdirectories within data/:
    # - amdwiki.page.provider.filesystem.storagedir: ./data/pages
    # - amdwiki.user.provider.storagedir: ./data/users
    # - amdwiki.attachment.provider.basic.storagedir: ./data/attachments
    # - amdwiki.logging.dir: ./data/logs
    # - amdwiki.search.provider.lunr.indexdir: ./data/search-index
    # - amdwiki.backup.directory: ./data/backups
    volumes:
      # All instance data (pages, users, attachments, logs, search-index, backups, sessions)
      - ../data:/app/data

      # Required pages (system templates - read-only, copied to data/pages on install)
      - ../required-pages:/app/required-pages

      # Optional: Mount custom configuration
      # Create app-custom-config.json locally to override settings
      # - ../config/app-custom-config.json:/app/config/app-custom-config.json

      # Optional: Mount environment-specific config
      # Uncomment to override the production config
      # - ../config/app-production-config.json:/app/config/app-production-config.json

    # Health check
    # Note: Health check uses container internal port (always 3000)
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:${CONTAINER_PORT:-3000}/', (r) => process.exit((r.statusCode === 200 || r.statusCode === 302) ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

    # Resource limits (optional)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

# Optional: Named volumes for better management
# Uncomment to use named volumes instead of bind mounts
# volumes:
#   amdwiki-data:

# Then update the service volumes section to:
#     volumes:
#       - amdwiki-data:/app/data
